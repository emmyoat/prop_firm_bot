<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropBot Cloud Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <header>
            <div style="display: flex; align-items: center; gap: 1.5rem;">
                <h1>ðŸ¤– PropBot Cloud</h1>
                <div class="account-switcher">
                    <span
                        style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase;">Account:</span>
                    <select id="bot-selector" onchange="window.selectedBotId = this.value; updateUI();">
                        <option value="">Detecting Bots...</option>
                    </select>
                </div>
            </div>
            <div class="last-updated" id="last-updated">Connecting...</div>
        </header>

        <div class="kpi-grid">
            <div class="card">
                <div class="card-label">Equity</div>
                <div class="card-value" id="equity">$0.00</div>
                <div class="card-delta" id="equity-delta">--</div>
            </div>
            <div class="card">
                <div class="card-label">Balance</div>
                <div class="card-value" id="balance">$0.00</div>
            </div>
            <div class="card">
                <div class="card-label">Daily PnL</div>
                <div class="card-value" id="daily-pnl">$0.00</div>
            </div>
            <div class="card">
                <div class="card-label">Daily DD</div>
                <div class="card-value" id="daily-dd">0.00%</div>
            </div>
            <div class="card">
                <div class="card-label">Overall DD</div>
                <div class="card-value" id="overall-dd">0.00%</div>
            </div>
            <div class="card">
                <div class="card-label">Win Rate</div>
                <div class="card-value" id="win-rate">0.0%</div>
            </div>
        </div>

        <section>
            <h2 style="margin-bottom: 1.5rem;">Active Positions</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ticket</th>
                            <th>Symbol</th>
                            <th>Type</th>
                            <th>Lots</th>
                            <th>Price</th>
                            <th>Current</th>
                            <th>Profit</th>
                        </tr>
                    </thead>
                    <tbody id="positions-table">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                Waiting for data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        window.allBotsData = {};
        window.selectedBotId = null;

        async function fetchData() {
            try {
                const response = await fetch('/api/index');
                const data = await response.json();

                if (data.error) {
                    document.getElementById('last-updated').textContent = 'Cloud Active: Waiting for Bot...';
                    return;
                }

                window.allBotsData = data;

                // Update Selector
                const selector = document.getElementById('bot-selector');
                const botIds = Object.keys(data);

                if (botIds.length > 0) {
                    // Update dropdown options if changed
                    const currentId = window.selectedBotId || botIds[0];
                    if (!window.selectedBotId) window.selectedBotId = currentId;

                    if (selector.options.length !== botIds.length || selector.value !== window.selectedBotId) {
                        selector.innerHTML = botIds.map(id => {
                            const botData = data[id];
                            const label = botData.account_name ? `${botData.account_name} (${id})` : `Bot #${id}`;
                            return `<option value="${id}" ${id === window.selectedBotId ? 'selected' : ''}>${label}</option>`;
                        }).join('');
                    }
                }

                updateUI();

            } catch (err) {
                console.error('Error fetching data:', err);
                document.getElementById('last-updated').textContent = 'Connection Error';
            }
        }

        function updateUI() {
            const botData = window.allBotsData[window.selectedBotId];
            if (!botData) return;

            // Update KPIs
            document.getElementById('equity').textContent = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(botData.equity);
            document.getElementById('balance').textContent = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(botData.balance);
            document.getElementById('daily-pnl').textContent = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(botData.daily_pnl);
            document.getElementById('daily-dd').textContent = botData.daily_dd.toFixed(2) + '%';
            document.getElementById('overall-dd').textContent = botData.overall_dd.toFixed(2) + '%';
            document.getElementById('win-rate').textContent = botData.win_rate.toFixed(1) + '%';

            const pnlElement = document.getElementById('daily-pnl');
            pnlElement.className = 'card-value ' + (botData.daily_pnl >= 0 ? 'positive' : 'negative');

            document.getElementById('last-updated').textContent = 'Last Sync: ' + botData.last_updated;

            // Update Positions
            const tbody = document.getElementById('positions-table');
            if (botData.open_positions && botData.open_positions.length > 0) {
                tbody.innerHTML = botData.open_positions.map(p => `
                    <tr>
                        <td>${p.ticket}</td>
                        <td>${p.symbol}</td>
                        <td><span class="status-badge status-live">${p.type}</span></td>
                        <td>${p.lots.toFixed(2)}</td>
                        <td>${p.open_price.toFixed(5)}</td>
                        <td>${p.current_price.toFixed(5)}</td>
                        <td class="${p.profit >= 0 ? 'positive' : 'negative'}">${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(p.profit)}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">No active positions</td></tr>';
            }
        }

        // Initial fetch
        fetchData();
        // Refresh every 5 seconds
        setInterval(fetchData, 5000);
    </script>
</body>

</html>